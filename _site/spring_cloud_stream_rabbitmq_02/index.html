<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/BlogPosting">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>ZUM 기술 블로그</title>
    <meta name="title" content="ZUM 기술 블로그"/>
    <meta name="description" content="생각을 읽다, ZUM, 고객의 생각을 읽고 담는 줌 인터넷 개발자들의 '좀 다른 개발 이야기'를 소개 합니다.">

    <meta property="og:title" content="줌인터넷 기술 블로그"/>
    <meta property="og:site_name" content="줌인터넷 기술 블로그"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://zuminternet.github.io/"/>
    <meta property="og:image" content="ttp://lego.zumst.com/resources/current/images/thumb_zum.jpg"/>
    <meta property="og:description" content="생각을 읽다, ZUM, 고객의 생각을 읽고 담는 줌 인터넷 개발자들의 '좀 다른 개발 이야기'를 소개 합니다."/>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/spring_cloud_stream_rabbitmq_02/">
    <link rel="alternate" type="application/rss+xml" title="ZUM 기술 블로그" href="http://localhost:4000/feed.xml" />
</head>

    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-google-plus" viewBox="0 0 951 1024"><path class="path1" d="M420 454.857q0 20.571 18.286 40.286t44.286 38.857 51.714 42 44 59.429 18.286 81.143q0 51.429-27.429 98.857-41.143 69.714-120.571 102.571t-170.286 32.857q-75.429 0-140.857-23.714t-98-78.571q-21.143-34.286-21.143-74.857 0-46.286 25.429-85.714t67.714-65.714q74.857-46.857 230.857-57.143-18.286-24-27.143-42.286t-8.857-41.714q0-20.571 12-48.571-26.286 2.286-38.857 2.286-84.571 0-142.571-55.143t-58-139.714q0-46.857 20.571-90.857t56.571-74.857q44-37.714 104.286-56t124.286-18.286h238.857l-78.857 50.286h-74.857q42.286 36 64 76t21.714 91.429q0 41.143-14 74t-33.714 53.143-39.714 37.143-34 35.143-14 37.714zM336.571 400q21.714 0 44.571-9.429t37.714-24.857q30.286-32.571 30.286-90.857 0-33.143-9.714-71.429t-27.714-74-48.286-59.143-66.857-23.429q-24 0-47.143 11.143t-37.429 30q-26.857 33.714-26.857 91.429 0 26.286 5.714 55.714t18 58.857 29.714 52.857 42.857 38.286 55.143 14.857zM337.714 898.857q33.143 0 63.714-7.429t56.571-22.286 41.714-41.714 15.714-62.286q0-14.286-4-28t-8.286-24-15.429-23.714-16.857-20-22-19.714-20.857-16.571-23.714-17.143-20.857-14.857q-9.143-1.143-27.429-1.143-30.286 0-60 4t-61.429 14.286-55.429 26.286-39.143 42.571-15.429 60.286q0 40 20 70.571t52.286 47.429 68 25.143 72.857 8.286zM800.571 398.286h121.714v61.714h-121.714v125.143h-60v-125.143h-121.143v-61.714h121.143v-124h60v124z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <a id="search" class="dosearch">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    <h1 class="logo">
        <img src="/images/portal/post/logo_zum_2x-78df1cde157641c8f4178f86826539e8.png"">
        <a href="/">
            
        </a>
    </h1>
</header>

<div id="mask" class="overlay"></div>

<aside id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
          <li><a href="http://localhost:4000">Home</a></li>
          <li><a href="http://zuminternet.com" target="_blank">Contact</a></li>
        <li><a class="feed" href="http://localhost:4000/feed.xml" title="Atom/RSS feed">Feed</a></li>
      </ul>
    </nav>
</aside>
<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>


        <section class="post">

            <article role="article" id="post" class="post-content" itemprop="articleBody">
                <p itemprop="post-info" class="post-info">
                    
                        <svg id="date" class="icon-calendar"><use xlink:href="#icon-calendar"></use></svg>
                        <time itemprop="datePublished" datetime="2017-07-12T00:00:00+09:00" class="date">
                            


July 12, 2017

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>19 min to read</span>
                </p>
                <h1 class="post-title" itemprop="name">SPRING CLOUD STREAM, MQ 도입 사례 -2</h1>
            <p/>
                <p>지난 번 글에 이어서 실제 연동 과정 입니다.</p>

<p>전체 글의 목차입니다.</p>

<ol>
  <li>도입 배경</li>
  <li>관련 연구</li>
  <li>RabbitMQ 따라잡기</li>
  <li>Spring Cloud Stream , RabbitMQ 연동하기</li>
  <li>추가 작업</li>
  <li>정리</li>
</ol>

<p>지난 글에는 도입배경, 관련연구, RabbitMQ에 대해서 설명하였습니다.<br />
<a href="https://zumdev.github.io/spring_cloud_stream_rabbitmq_01/">SPRING CLOUD STREAM, MQ 도입 사례 - 1.기본개념</a></p>

<p>이번 글에서는 Spring Cloud Stream, Rabbit 연동하기 및 추가 작업에 대해서 공유합니다.</p>

<h1 id="4-rabbitmq-연동하기">4. RabbitMQ 연동하기</h1>

<p>자바+스프링 웹서비스 환경에서 RabbitMQ 연동을 할수 있는 방법에 대해서 소개합니다.
참고로 Consumer(=Subcribe) 입장에서만 정리하였습니다.</p>

<ul>
  <li>RabbitMQ Java client library(com.rabbitmq.client)</li>
  <li>Spring Framework RabbitMQ</li>
  <li>Spring Cloud Stream RabbitMQ binder 1.0.3</li>
  <li>Spring Cloud Stream RabbitMQ binder 1.2.0</li>
</ul>

<h4 id="41-rabbitmq-java-client-library">4.1 RabbitMQ Java client library</h4>

<p>com.rabbitmq.client 입니다.
기본적인 연동 프로세스는 ConnectionFactory –&gt; Connection –&gt; Channel 생성의 순서입니다.</p>

<ul>
  <li>ConnectionFactory :</li>
  <li>Connection :</li>
  <li>Channel :</li>
</ul>

<p><img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_scs_rabbit01.png" alt="rabbitmq 기본 연동" /></p>

<p>급하게(?) 그려본 시퀀스 다이어그램을 보면 ConnectionFactory 팩토리를 생성하고, 팩토리에서 newConnection() 으로 커넥션 객체를 생성합니다.
커넥션 객체에서는 createChannel() 를 실행하여 채널을 생성하는 프로세스입니다.
소스 예제는 아래와 같습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.rabbitmq.client.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rabbitmq.client.Channel</span><span class="o">;</span>

<span class="n">ConnectionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConnectionFactory</span><span class="o">();</span>
<span class="n">factory</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
<span class="n">factory</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
<span class="n">factory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="n">virtualHost</span><span class="o">);</span>
<span class="n">factory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="n">hostName</span><span class="o">);</span>
<span class="n">factory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="n">portNumber</span><span class="o">);</span>
<span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span> <span class="c1">// 커넥션 생성</span>

<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

<span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span> <span class="c1">// 채널 생성</span></code></pre></figure>

<p><code class="highlighter-rouge">Channel</code> 객체에서는 익스체인지 선언, 큐 선언, 익스체인지-큐 바인딩 등 핵심 작업을 수행합니다.
각 역할에 따라서 exchangeDeclare(), queueDeclare(), queueBind() 를 사용합니다. 정리하면</p>

<p>팩토리–&gt;커넥션–&gt;채널–&gt;익스체인지 선언–&gt;큐 선언 –&gt; 큐 바인딩</p>

<p>순서로 RabbitMQ 연동을 합니다.</p>

<p>자… 굳이 이부분을 왜 설명을 하냐면요, 스프링에서 제공해주는 기술도 마찬가지로 똑같은 프로세스로 실행하기 때문입니다.
기본 흐름은 이해 할 필요는 있습니다.</p>

<p>참고로 연결을 실패했거나 강제로 채널 또는 커넥션이 종료가 된 경우를 대비하여 아래와 같이 셧다운 이벤트 리스너를 추가할 수 있습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">com.rabbitmq.client.ShutdownSignalException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.rabbitmq.client.ShutdownListener</span><span class="o">;</span>

<span class="n">connection</span><span class="o">.</span><span class="na">addShutdownListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ShutdownListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdownCompleted</span><span class="o">(</span><span class="n">ShutdownSignalException</span> <span class="n">cause</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">});</span></code></pre></figure>

<p>자세한 내용은 RabbitMQ 공식 가이드에서 확인 가능합니다.<br />
<a href="https://www.rabbitmq.com/api-guide.html" target="_blank">https://www.rabbitmq.com/api-guide.html</a></p>

<h4 id="42-spring-framework-rabbitmq">4.2 Spring Framework RabbitMQ</h4>

<p>Spring Cloud Stream 이 나오기 전에, 대부분은 스프링 환경의 플랫폼에서는 해당 라이브러리(org.springframework.amqp)로 RabbitMQ 연동을 구축하였을 것입니다. 
실제로 사내 서비스에서도 해당 방법으로 연동하였습니다.</p>

<p>일단 <code class="highlighter-rouge">ORG.SPRINGFRAMEWORK.AMQP</code> 는 기본적으로 4.1에서 소개한 RabbitMQ Java client library(com.rabbitmq.client)를 사용합니다.</p>

<p><img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_spring_mq_useview.png" alt="Spring MQ - 사용뷰" /></p>

<p>스프링 레퍼런스에서 제공하는 샘플 소스는 아래와 같습니다.
팩토리–&gt;커넥션–&gt;채널–&gt;익스체인지 선언–&gt;큐 선언 –&gt; 큐 바인딩 의 연동 프로세스는 같습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">hello</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.Binding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.BindingBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.Queue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.TopicExchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.connection.ConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.listener.adapter.MessageListenerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"spring-boot"</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="n">Queue</span> <span class="nf">queue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="n">TopicExchange</span> <span class="nf">exchange</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TopicExchange</span><span class="o">(</span><span class="s">"spring-boot-exchange"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="n">Binding</span> <span class="nf">binding</span><span class="o">(</span><span class="n">Queue</span> <span class="n">queue</span><span class="o">,</span> <span class="n">TopicExchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">queueName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="n">SimpleMessageListenerContainer</span> <span class="nf">container</span><span class="o">(</span><span class="n">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">,</span>
            <span class="n">MessageListenerAdapter</span> <span class="n">listenerAdapter</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SimpleMessageListenerContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleMessageListenerContainer</span><span class="o">();</span>
        <span class="n">container</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
        <span class="n">container</span><span class="o">.</span><span class="na">setQueueNames</span><span class="o">(</span><span class="n">queueName</span><span class="o">);</span>
        <span class="n">container</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="n">listenerAdapter</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">container</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="n">MessageListenerAdapter</span> <span class="nf">listenerAdapter</span><span class="o">(</span><span class="n">Receiver</span> <span class="n">receiver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MessageListenerAdapter</span><span class="o">(</span><span class="n">receiver</span><span class="o">,</span> <span class="s">"receiveMessage"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>상세한 가이드는 https://spring.io/guides/gs/messaging-rabbitmq/ 에서 확인 가능합니다.</p>

<h4 id="43-spring-cloud-stream-binder-rabbit-103-release">4.3 Spring Cloud Stream Binder Rabbit 1.0.3 RELEASE</h4>

<p>이제 드디어!! <code class="highlighter-rouge">Spring Cloud Stream</code> 를 검토해보는 시간입니다. 
참고로 Spring Cloud Stream Binder Rabbit 1.0.3 RELEASE 를 적용하기 위해서는 스프링부트 버전이 최소 1.3.7 (디펜던시)적용이 필요합니다.</p>

<p>일단 모듈뷰-사용뷰 는 이렇습니다.
<img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_spring_cloud_stream_rabbitmq_useview.png" alt="Spring Cloud Stream RabbitMQ - 사용뷰" /></p>

<p>대략적인 시퀀스 다이어그램은 아래와 같습니다.
<img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_scs_release_103_01.png" alt="Spring Cloud Stream 1.0.3 RELEASE" /></p>

<p><img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_scs_release_103_02.png" alt="Spring Cloud Stream 1.0.3 RELEASE" /></p>

<p>익스체인지 선언, 큐 선언, 익스체인지-큐 바인딩 하는 부분은 이렇게 구현이 되어있네요.
핵심 로직은 doBindConsumer() 에서 구현되어 있습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">RabbitMessageChannelBinder</span>


<span class="kd">public</span> <span class="n">Binding</span><span class="o">&lt;</span><span class="n">MessageChannel</span><span class="o">&gt;</span> <span class="nf">doBindConsumer</span><span class="o">(</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="c1">//익스체인지 선언</span>
<span class="n">TopicExchange</span> <span class="n">exchange</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopicExchange</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">);</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span></code></pre></figure>

<p>읭??? 익스체인지 선언을 TopicExchange 으로 합니다. 무조건 익스체인지 타입을 Topic 으로만 만들겠다는 그런 소스입니다만?? 뭐지?</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">RabbitMessageChannelBinder</span>


<span class="kd">public</span> <span class="n">Binding</span><span class="o">&lt;</span><span class="n">MessageChannel</span><span class="o">&gt;</span> <span class="nf">doBindConsumer</span><span class="o">(</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="c1">//큐 선언</span>
<span class="n">declareQueue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>

<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

<span class="c1">//실제 큐를 생성하는 로직</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareQueue</span><span class="o">(</span><span class="n">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">Queue</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">rabbitAdmin</span><span class="o">.</span><span class="na">declareQueue</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">AmqpConnectException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Declaration of queue: "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" deferred - connection not available"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="n">addToAutoDeclareContext</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">RabbitMessageChannelBinder</span>

<span class="kd">public</span> <span class="n">Binding</span><span class="o">&lt;</span><span class="n">MessageChannel</span><span class="o">&gt;</span> <span class="nf">doBindConsumer</span><span class="o">(</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="c1">//익스체인지-큐 바인딩 호출</span>
<span class="k">if</span> <span class="o">(</span><span class="n">partitioned</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">bindingKey</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s-%d"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">properties</span><span class="o">.</span><span class="na">getInstanceIndex</span><span class="o">());</span>
	<span class="n">declareBinding</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">bindingKey</span><span class="o">));</span>
<span class="o">}</span>
<span class="k">else</span> <span class="o">{</span>
	<span class="n">declareBinding</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="s">"#"</span><span class="o">));</span>
<span class="o">}</span>

<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>

<span class="c1">//실제로 익스체인지-큐 바인딩하는 부분</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareBinding</span><span class="o">(</span><span class="n">String</span> <span class="n">rootName</span><span class="o">,</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">amqp</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">Binding</span> <span class="n">binding</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">rabbitAdmin</span><span class="o">.</span><span class="na">declareBinding</span><span class="o">(</span><span class="n">binding</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="n">AmqpConnectException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Declaration of binding: "</span> <span class="o">+</span> <span class="n">rootName</span> <span class="o">+</span> <span class="s">".binding deferred - connection not available"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="n">addToAutoDeclareContext</span><span class="o">(</span><span class="n">rootName</span> <span class="o">+</span> <span class="s">".binding"</span><span class="o">,</span> <span class="n">binding</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>또한 소스를 자세히 보면 바인딩키는 오직 name-instanceIndex 의 형태로 구현되어있습니다. 여기서 name은 익스체인지 name 입니다. 
뭐지?? Topic 타입인데 바인딩키가 exchange-index 의 형태입니다. 예를 들어서 익스체인지 이름이 news 이고 index 가 1 이면 news-1 이런 형태입니다.
제가 위에 설명했던 *.news.# 이런 형태로 *, # 이 적용된 형태로 바인딩키를 설정할 수 없습니다.
아무튼 Topic 타입인데 *,# 를 사용하지 않는다면 이건 Topic 타입을 Direct 타입 처럼 쓰고 싶을때 하는 그 방법입니다.
또한 partitioned 가 false 일 경우에는 bindingKey 는 # 으로 설정됩니다. 
Topic 타입에서 바인딩키를 #으로 설정 된 경우에는 위에서 설명한 듯이 Fanout 타입 처럼 동작합니다.</p>

<p>다시 정리하면 Spring Cloud Stream <code class="highlighter-rouge">1.0.3</code> RELEASE 버전은 오직 Topic 타입만 제공합니다!
프로퍼티 설정인 partitioned 의 true/false 에 따라서 Fanout 처럼 또는 Direct 처럼 사용할 수만 있고 Topic 타입으로는 쓸수 없을 것 같습니다. 
바인딩키 설정 또한 매우 제한적입니다.</p>

<p>여기까지는 라이브러리 백단 소스를 분석한 것이고, 실제로 MQ 연동 적용은 아주 간단합니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//스트림 연동하기</span>
<span class="nd">@EnableBinding</span><span class="o">(</span><span class="n">Sink</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">listener</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="nd">@StreamListener</span><span class="o">(</span><span class="n">Sink</span><span class="o">.</span><span class="na">INPUT</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processVote</span><span class="o">(</span><span class="n">Vote</span> <span class="n">vote</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//service </span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>1.0.3 버전에 대한 상세한 레퍼런스는 아래 링크에서 참고 가능합니다.<br />
<a href="http://docs.spring.io/spring-cloud-stream/docs/1.0.3.RELEASE/reference/htmlsingle/index.html" target="_blank">레퍼런스링크</a></p>

<p>혹시라도 제가 소스를 잘못 봤거나 했다면 꼭 말씀부탁드리겠습니다ㅠㅠ 제가 잘 몰라서 멍청하게 헤매고 있을 가능성도 있습니다.</p>

<blockquote>
  <p>1.0.3.RELEASE 버전은 라우팅 규칙을 적용하기에는 너무나도 제한적인 라우팅키,익스체인지타입 으로 구성되어 있습니다.</p>
</blockquote>

<p>자 그래서 저는 1.0.3 버전은 실서비스에 적용하기에는 애매하다 라는 결론을 내렸습니다.
익스체인지 타입도 지정못하고, 라우팅키도 설정도 제한적이라면 차라리 Spring Cloud Stream 안쓰고 
4.2 Spring Framework RabbitMQ(org.springframework.amqp)로 구현하는게 낫겠다는 생각도 했지만 일단 상위 버전을 검토해보기로 했습니다.</p>

<p>참고로 밑에 작성하겠지만 <code class="highlighter-rouge">1.2.0.RELEASE</code> 버전은 서비스에 적용하기에 괜찮다는 결론을 내렸습니다.</p>

<h4 id="44-spring-cloud-stream-binder-rabbit-120-release-소스-분석">4.4 Spring Cloud Stream Binder Rabbit 1.2.0 RELEASE 소스 분석</h4>

<p>나름 최근 버전인 <code class="highlighter-rouge">Release 1.2.0</code> 을 살펴볼려고 합니다. 스프링 부트 1.5.2 버전이 최소 적용이 디펜던시로 적용되어야 합니다.
참고로, 처음부터 1.2.0 버전을 확인하지 않은 이유는 스프링 부트 버전 때문이었습니다. 
프로젝트의 스프링부트 버전의 업그레이드로 인해서 해당 서비스에서 수정 및 테스트 해야 하는 내용이 많아졌습니다.</p>

<p><img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_scs_release_103_01.png" alt="Spring Cloud Stream 1.0.3 RELEASE" />
기본적인 connection, channel 등 초기 작업은 1.0.3.RELEASE 와 유사합니다.</p>

<p><img src="/images/portal/post/2017-7-12-spring_cloud_stream_rabbitmq_02/20170610_scs_release_1_2_0.png" alt="Spring Cloud Stream 1.2.0 RELEASE" /></p>

<p>Exchange, 큐 생성 및 바인딩 하는 로직은 1.0.3.RELEASE 와 많이 변경이 되었고 
주요 로직은 RabbitExchangeQueueProvisioner -&gt; provisionConsumerDestination() 에서 확인 가능합니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">AbstractMessageChannelBinder</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="n">Binding</span><span class="o">&lt;</span><span class="n">MessageChannel</span><span class="o">&gt;</span> <span class="nf">doBindConsumer</span><span class="o">(</span>
<span class="o">...</span>
    <span class="kd">final</span> <span class="n">ConsumerDestination</span> <span class="n">destination</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">provisioningProvider</span><span class="o">.</span><span class="na">provisionConsumerDestination</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">group</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
<span class="o">...</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binder</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">provisioning</span><span class="o">.</span><span class="na">RabbitExchangeQueueProvisioner</span>


<span class="kd">public</span> <span class="n">ConsumerDestination</span> <span class="nf">provisionConsumerDestination</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">String</span> <span class="n">group</span><span class="o">,</span> <span class="n">ExtendedConsumerProperties</span><span class="o">&lt;</span><span class="n">RabbitConsumerProperties</span><span class="o">&gt;</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
	<span class="kt">boolean</span> <span class="n">anonymous</span> <span class="o">=</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
	<span class="n">String</span> <span class="n">baseQueueName</span> <span class="o">=</span> <span class="n">anonymous</span> <span class="o">?</span> <span class="n">groupedName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">ANONYMOUS_GROUP_NAME_GENERATOR</span><span class="o">.</span><span class="na">generateName</span><span class="o">())</span>
			<span class="o">:</span> <span class="n">groupedName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">group</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"declaring queue for inbound: "</span> <span class="o">+</span> <span class="n">baseQueueName</span> <span class="o">+</span> <span class="s">", bound to: "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="n">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">().</span><span class="na">getPrefix</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="n">applyPrefix</span><span class="o">(</span><span class="n">prefix</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
	<span class="n">Exchange</span> <span class="n">exchange</span> <span class="o">=</span> <span class="n">buildExchange</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(),</span> <span class="n">exchangeName</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">().</span><span class="na">isDeclareExchange</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">declareExchange</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">exchange</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="n">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="n">applyPrefix</span><span class="o">(</span><span class="n">prefix</span><span class="o">,</span> <span class="n">baseQueueName</span><span class="o">);</span>
	<span class="kt">boolean</span> <span class="n">partitioned</span> <span class="o">=</span> <span class="o">!</span><span class="n">anonymous</span> <span class="o">&amp;&amp;</span> <span class="n">properties</span><span class="o">.</span><span class="na">isPartitioned</span><span class="o">();</span>
	<span class="kt">boolean</span> <span class="n">durable</span> <span class="o">=</span> <span class="o">!</span><span class="n">anonymous</span> <span class="o">&amp;&amp;</span> <span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">().</span><span class="na">isDurableSubscription</span><span class="o">();</span>
	<span class="n">Queue</span> <span class="n">queue</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">anonymous</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">queueArgs</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(),</span> <span class="kc">false</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">partitioned</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">String</span> <span class="n">partitionSuffix</span> <span class="o">=</span> <span class="s">"-"</span> <span class="o">+</span> <span class="n">properties</span><span class="o">.</span><span class="na">getInstanceIndex</span><span class="o">();</span>
			<span class="n">queueName</span> <span class="o">+=</span> <span class="n">partitionSuffix</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">durable</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
					<span class="n">queueArgs</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(),</span> <span class="kc">false</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
					<span class="n">queueArgs</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(),</span> <span class="kc">false</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="n">declareQueue</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>
	<span class="n">Binding</span> <span class="n">binding</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">().</span><span class="na">isBindQueue</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">binding</span> <span class="o">=</span> <span class="n">declareConsumerBindings</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">properties</span><span class="o">,</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">partitioned</span><span class="o">,</span> <span class="n">queue</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">durable</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">autoBindDLQ</span><span class="o">(</span><span class="n">applyPrefix</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">().</span><span class="na">getPrefix</span><span class="o">(),</span> <span class="n">baseQueueName</span><span class="o">),</span> <span class="n">queueName</span><span class="o">,</span>
				<span class="n">properties</span><span class="o">.</span><span class="na">getExtension</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">RabbitConsumerDestination</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">binding</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>소스를 보시면 익스체인지 타입 과 라우팅 키를 Properties 에서 설정할 수 있도록 구현되어 있습니다.
그래서 1.2.0.RELEASE 에서는 (1.0.3.RELEASE비교하여) 아래와 같은 차이점이 있습니다.</p>

<ul>
  <li>익스체인지 타입을 지정할 수 있다.</li>
  <li>바인딩키를 지정할 수 있다.</li>
  <li>등등 내가 모르는 많은 기능이 적용이 되었다;</li>
</ul>

<p>결국 스프링부트 버전을 올리는 RISK 를 감안하고 1.2.0.RELEASE 를 적용하는 것이 좋겠다고 판단하였습니다. 
부끄럽지만 현재 스프링부트 버전이… 1.1.3…</p>

<h4 id="45-spring-cloud-stream-binder-rabbit-120-release-적용-해보기">4.5 Spring Cloud Stream Binder Rabbit 1.2.0 RELEASE 적용 해보기</h4>

<p>이제 드디어 Spring Cloud Stream 프로젝트로 RabbitMQ 를 연동해봤습니다.</p>

<p><code class="highlighter-rouge">Gradle</code> 에 디펜던시 설정을 추가합니다. 스프링부트 버전도 업그레이드 했기 때문에 boot 버전도 변경하였습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">build</span><span class="o">.</span><span class="na">gradle</span>

<span class="n">dependencies</span> <span class="o">{</span>
	
	<span class="o">.</span>
	<span class="o">.</span>
	<span class="o">.</span>
	<span class="n">compile</span><span class="o">(</span><span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">cloud</span><span class="o">:</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="nl">rabbit:</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">RELEASE</span><span class="err">'</span><span class="o">)</span></code></pre></figure>

<p><code class="highlighter-rouge">Properties</code> 설정을 추가합니다. 참고로 설정 관련해서는 반드시 레퍼런스 참고 부탁드립니다. 해당 설정은 저희 프로젝트 환경에 맞게 변경된 내용입니다.</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="n">application</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="na">properties</span>

<span class="k">dependencies</span> <span class="o">{</span>
	
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">SINK</span><span class="o">-</span><span class="n">INPUT</span><span class="o">-</span><span class="n">TEST</span><span class="o">.</span><span class="na">destination</span><span class="o">=</span><span class="n">news</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">SINK</span><span class="o">-</span><span class="n">INPUT</span><span class="o">-</span><span class="n">TEST</span><span class="o">.</span><span class="na">group</span><span class="o">=</span><span class="err">서버의</span> <span class="err">유니크한</span> <span class="err">값</span> <span class="err">설정</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">SINK</span><span class="o">-</span><span class="n">TEST</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">bindingRoutingKey</span><span class="o">=</span><span class="n">newsbox</span><span class="o">.</span><span class="na">update</span><span class="o">.</span><span class="na">test</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">SINK</span><span class="o">-</span><span class="n">TEST</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">exchangeType</span><span class="o">=</span><span class="n">direct</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">bindings</span><span class="o">.</span><span class="na">SINK</span><span class="o">-</span><span class="n">TEST</span><span class="o">.</span><span class="na">consumer</span><span class="o">.</span><span class="na">durableSubscription</span><span class="o">=</span><span class="kc">false</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">stream</span><span class="o">.</span><span class="na">binders</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">type</span><span class="o">=</span><span class="n">rabbit</span>
	
	<span class="c1">//참고로 rabbitMQ 관련 설정 정보를 따로 properties 에 분리했습니다.</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">host</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">rabbitmq</span><span class="o">.</span><span class="na">host</span><span class="o">}</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">virtual</span><span class="o">-</span><span class="n">host</span><span class="o">=</span><span class="n">testhost</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">username</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">rabbitmq</span><span class="o">.</span><span class="na">username</span><span class="o">}</span>
	<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">password</span><span class="o">=</span><span class="n">$</span><span class="o">{</span><span class="n">rabbitmq</span><span class="o">.</span><span class="na">password</span><span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">listener</span><span class="o">.</span><span class="na">java</span>
	
<span class="nd">@EnableBinding</span><span class="o">(*****</span><span class="n">Listener</span><span class="o">.</span><span class="na">Sink</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="err">*****</span><span class="nc">Listener</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">News</span><span class="o">*****</span><span class="n">Dao</span> <span class="n">news</span><span class="o">*****</span><span class="n">Dao</span><span class="o">;</span>

    <span class="nd">@StreamListener</span><span class="o">(</span><span class="n">Sink</span><span class="o">.</span><span class="na">inboundTest</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="n">PojoTest</span> <span class="n">pojotest</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span><span class="o">(</span><span class="n">pojotest</span><span class="o">.</span><span class="na">is</span><span class="o">***()){</span>
            
            <span class="c1">//뉴스 업데이트 비즈니스 로직 </span>
           
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Sink</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">inboundTest</span> <span class="o">=</span> <span class="s">"SINK-TEST"</span><span class="o">;</span>

        <span class="nd">@Input</span><span class="o">(</span><span class="n">inboundTest</span><span class="o">)</span>
        <span class="n">SubscribableChannel</span> <span class="o">*****</span><span class="n">Listener</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>너무 간단하지만 이걸로 끝입니다.</p>

<h4 id="46-정리">4.6 정리</h4>

<p>Spring Cloud Stream 를 적용하여 RabbitMQ 를 연동하는 과정을 정리해봤습니다.
부족한 실력으로 혼자서 삽질을 많이 했습니다. 혹시라도 틀린 내용 있거나 다른 의견 있으시면 꼭 말씀 부탁드리겠습니다.</p>

<blockquote>
  <p>처음부터 1.2.0.RELEASE 버전을 검토 했으면 좋았을 것을………….ㅠㅠ 어쨋든 현재 서비스에 영향을 최소화하고 싶어서 부트 버전 업그레이드를 주저했었습니다.</p>
</blockquote>

<h1 id="5-추가-작업">5. 추가 작업</h1>

<p>기본적인 연동작업 외에 추가로 작업한 내용에 대해서 공유합니다.</p>

<h4 id="51-spring-boot-버전-업그레이드">5.1 Spring Boot 버전 업그레이드</h4>

<p>Spring Cloud Stream 1.2.0.RELEASE 를 적용하기 위해서는 스프링 부트의 버전을 1.5.2 까지 업그레이드 해야 합니다.</p>

<p>현재 스프링부트의 버전은 1.1.X 로 비교적 낮은 버전이 적용되어 있었습니다. 
그동안 운영에 큰 지장은 없었습니다만, 이번 기회에 부트 버전을 1.5.2 로 올렸습니다. 올리면서 진행한 작업은 아래와 같습니다.</p>

<p>작성 중</p>

<h4 id="52-장애대응-1shutdown-listener-연동">5.2 [장애대응-1]ShutDown listener 연동</h4>

<p>RabbitMQ 의 장애 또는 강제 커넥션 종료로 인한 셧다운 발생 시 서비스 대응 작업이 필요했습니다. 
CachingConnectionFactory 소스를 보면 아래 소스처럼 셧다운이 발생하면 로그만 남기도록 되어있습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">amqp</span><span class="o">.</span><span class="na">rabbit</span><span class="o">.</span><span class="na">connection</span><span class="o">.</span><span class="na">CachingConnectionFactory</span>

<span class="o">.</span>
<span class="o">.</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdownCompleted</span><span class="o">(</span><span class="n">ShutdownSignalException</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">closeExceptionLogger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">logger</span><span class="o">,</span> <span class="s">"Channel shutdown"</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>CachingConnectionFactory 를 생성해주는 RabbitAutoConfiguration 클래스를 확인해보면 아래와 같이 @ConditionalOnMissingBean (ConnectionFactory.class) 로 되어있습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">autoconfigure</span><span class="o">.</span><span class="na">amqp</span><span class="o">.</span><span class="na">RabbitAutoConfiguration</span>


<span class="nd">@Configuration</span>
	<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">ConnectionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">protected</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">RabbitConnectionFactoryCreator</span> <span class="o">{</span>

		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="n">CachingConnectionFactory</span> <span class="nf">rabbitConnectionFactory</span><span class="o">(</span><span class="n">RabbitProperties</span> <span class="n">config</span><span class="o">)</span>
				<span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="o">.</span>
		<span class="o">.</span>
		<span class="o">.</span>
		<span class="c1">//실제로 이 부분을 변경할 것입니다...</span>
		<span class="n">CachingConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachingConnectionFactory</span><span class="o">(</span>
					<span class="n">factory</span><span class="o">.</span><span class="na">getObject</span><span class="o">());</span></code></pre></figure>

<p>그래서 저는 CachingConnectionFactory Bean 생성하는 소스를 그대로 복사해서 
신규 클래스로 작성하였고 CachingConnectionFactory 생성하는 부분에서 shutdownCompleted 만 오버라이드 했습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CachingConnectionFactory</span> <span class="nf">rabbitConnectionFactory</span><span class="o">(</span><span class="n">RabbitProperties</span> <span class="n">config</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="c1">//라이브러스 소스와 똑같이 구현</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">CachingConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CachingConnectionFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getObject</span><span class="o">()){</span>


            <span class="c1">//셧다웃 이벤트 발생 시 비즈니스 로직 적용</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdownCompleted</span><span class="o">(</span><span class="n">ShutdownSignalException</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">//비즈니스 로직 적용</span>
                <span class="o">***</span><span class="n">Dao</span><span class="o">.~~~;</span> 
                
                <span class="kd">super</span><span class="o">.</span><span class="na">shutdownCompleted</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="c1">//라이브러리 소스와 똑같이</span>
		<span class="o">.</span></code></pre></figure>

<p>혹시 이런 방법에 대해서 의문점이나 잘못된 사항이 있다면 꼭 피드백 부탁드립니다ㅠㅠ</p>

<h4 id="53-장애대응-2커넥션-실패-등-장애상황에-대한-테스트">5.3 [장애대응-2]커넥션 실패 등 장애상황에 대한 테스트</h4>

<p>장애 상황에 대해서 여러가지로 테스트를 해봤습니다.</p>

<p><code class="highlighter-rouge">스프링 부트를 처음 올리는 경우</code></p>

<ul>
  <li>MQ 서버 네트웍이 끊긴 경우 -&gt;부트 올라옴, 단 커넥션타임아웃이 60초로 설정되어 있음</li>
  <li>MQ 서버는 정상이지만 RabbitMQ 중지된 경우 -&gt; 부트 올라옴</li>
  <li>설정된 vhost 정보가 잘못된 경우 -&gt; 부트 올라옴</li>
  <li>설정된 rabbitmq.password 가 잘못된 경우 -&gt; 부트 안올라옴</li>
</ul>

<p><code class="highlighter-rouge">스프링 부트가 올라와 있는 서비스 중 상황에서</code></p>

<ul>
  <li>갑자기 MQ 서버 네트워이 끊긴 경우 -&gt; 커넥션 끊기지만 서비스 지장 없음, MQ 네트워크 연결되면 자동 커넥션 맺음</li>
  <li>RabbitMQ 관리툴에서 커넥션을 강제로 중지한 경우 -&gt; 재연결 됨</li>
  <li>(그럴리가 없겠지만)관리자가 갑자기 exchange 를 제거한 경우 -&gt; ???</li>
</ul>

<p>기타 상황에 대해서 테스트를 해본 결과 서비스에 크게 지장될 만한 사항은 없는 것 같다는 생각이었습니다. 
누군가가 MQ의 비번을 갑자기 바꿀 경우도 없을 테고…</p>

<p>단 네트워크가 끊겼을 경우 갑자기 부트를 올려야 하는 상황이라면 사실 60초의 커넥션은 너무 길게 느껴질수는 있습니다.
MQ 서버로의 장애와 상관없이 부트 애플리케이션은 빠르게 정상적으로 올라와야 합니다. 
(참고로 MQ 가 연동이 되지 않으면 기존 로직(뉴스기사가 API 연동)이 작동합니다. 셧다운 됐을때도 마찬가지로 대응 로직이 적용됩니다.)</p>

<p>어쨋든 CachingConnectionFactory 선언한 부분에서 아래와 같이 초기 연결시 타임아웃을 3초로 변경하였습니다.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CachingConnectionFactory</span> <span class="nf">rabbitConnectionFactory</span><span class="o">(</span><span class="n">RabbitProperties</span> <span class="n">config</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="c1">//라이브러스 소스와 똑같이 구현</span>
        <span class="o">.</span>
        <span class="o">.</span>
	<span class="c1">//팩토리 생성 이후에 로직에 추가</span>
	<span class="c1">//초기 연결 시 타이아웃 60초 -&gt; 3초</span>
	<span class="n">connectionFactory</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span></code></pre></figure>

<h4 id="53-ha-or-l4-구성-및-클러스터링-검토">5.3 HA or L4 구성 및 클러스터링 검토</h4>

<p>HA구성을 검토하였으나 서버 담당자와 논의 끝에 L4 Active/Standby 이중화 구성을 하였습니다. (로드 밸런싱 아님!!)
그리고 고민을 많이 했지만 해당 Message 정보는 유실되어도 상관없는 정보이기 때문에 클러스터링 없이 구성하였습니다.
일반적으로는 클러스터링 구성해서 진행하겠지만, 추후에 검토하기로 했습니다.</p>

<p>MQ 서버 1 번에 L4 를 통해서 연결되어 있는 상황에서 갑작스럽게 MQ서버1 이 죽으면 자동으로 L4 에서 Standby 서버인 Mq 2번 서버로 재연결 합니다.
서버1의 큐는 자동으로 삭제 되고 MQ2 에 신규 큐가 생성이 됩니다.</p>

<p>참고로 Spring Cloud Stream 으로 연동되는 큐는 AutoDelete 설정을 추가하였습니다.</p>

<h1 id="6-정리">6. 정리</h1>

<p>시간이 없어서 주저리주저리 작성해봤습니다. 나중에 시간이 된다면 깔끔하게 글 정리해보겠습니다.</p>

<p>암튼 서비스 적용 전에 피드백을 받고 싶어서 부끄럽지만 용기를 내서 공유를 해봅니다. 
좋은 의견 있으시면 꼭 말씀 부탁드리겠습니다.</p>

<p>허접하지만 긴 글 읽어주셔서, 감사합니다.</p>

            </article>

            <div class="progress-bar" data-minutes="19">
                <span class="time-completed"></span>
                <span class="time-remaining"></span>
                <div class="bar">
                    <span class="completed" style="width:0%;"></span>
                    <span class="remaining" style="width:100%;"></span>
                </div>
            </div>

            <!--<section class="share">-->
    <!--<h3>Share</h3>-->
    <!--<a aria-label="Compartilhar no Twitter" href="https://twitter.com/intent/tweet?text=&quot;&quot;%20http://localhost:4000/spring_cloud_stream_rabbitmq_02/%20via%20&#64;@zum_com&hashtags=spring,cloud,rabbitmq,microservices,"-->
    <!--onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">-->
        <!--<svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>-->
    <!--</a>-->
    <!--<a aria-label="Compartilhar no Facebook"href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/spring_cloud_stream_rabbitmq_02/"-->
    <!--onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">-->
        <!--<svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>-->
    <!--</a>-->
    <!--<a aria-label="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:4000/spring_cloud_stream_rabbitmq_02/"-->
    <!--onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">-->
        <!--<svg class="icon icon-google-plus"><use xlink:href="#icon-google-plus"></use></svg>-->
    <!--</a>-->
<!--</section>-->

            <section class="author" itemprop="author">
  <div class="details" itemscope itemtype="http://schema.org/Person">
    <img itemprop="image" class="img-rounded" src="/images/portal/author/sieunkim.png" alt="">
    <p class="def">포털개발팀 김시은 책임</p>
    <h3 class="name">
      <a itemprop="name" href="https://github.com/zuminternet"></a>
    </h3>
    <p class="desc">Front-End & Back-End Senior Developer.</p>
    <p>
      
      <a itemprop="github" href="https://github.com/zuminternet" title="Github">
        <svg><use xlink:href="#icon-github"></use></svg>
      </a>
      
      
      <a itemprop="facebook" href="https://www.facebook.com/zumcom" title="Facebook">
        <svg><use xlink:href="#icon-facebook"></use></svg>
      </a>
      
      
      <a itemprop="twitter" href="https://twitter.com/@zum_com" title="Twitter">
        <svg><use xlink:href="#icon-twitter"></use></svg>
      </a>
      
      
      
      
    </p>
  </div>
</section>

            <!--<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'disqus_username';
        var disqus_title = '';
        var disqus_url = '/spring_cloud_stream_rabbitmq_02/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>
-->
            <footer>
    <p>
      
      <a itemprop="github" href="https://github.com/zuminternet" title="Github">
        <svg><use xlink:href="#icon-github"></use></svg>
      </a>
      
      
      <a itemprop="facebook" href="https://www.facebook.com/zumcom" title="Facebook">
        <svg><use xlink:href="#icon-facebook"></use></svg>
      </a>
      
      
      <a itemprop="twitter" href="https://twitter.com/@zum_com" title="Twitter">
        <svg><use xlink:href="#icon-twitter"></use></svg>
      </a>
      
      
      
      
    </p>
    <ul>

        <!---->
          <!--<li><a href="http://localhost:4000">Home</a></li>-->
        <!---->
          <!--<li><a href="http://localhost:4000">Contact</a></li>-->
        <!---->

        <li><a href="http://localhost:4000">Home</a></li>
        <li><a href="http://zuminternet.com" target="_blank">Contact</a></li>
        <li><a class="feed" href="http://localhost:4000/feed.xml" title="Atom/RSS feed">Feed</a></li>
    </ul>
</footer>
<script src="/assets/js/main.js"></script>
// <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-XXXXXXXX-X', 'auto');
  ga('send', 'pageview');

</script>
  


        </section>
    </body>
</html>
