<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/BlogPosting">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>ZUM 기술 블로그</title>
    <meta name="title" content="ZUM 기술 블로그"/>
    <meta name="description" content="생각을 읽다, ZUM, 고객의 생각을 읽고 담는 줌 인터넷 개발자들의 '좀 다른 개발 이야기'를 소개 합니다.">

    <meta property="og:title" content="줌인터넷 기술 블로그"/>
    <meta property="og:site_name" content="줌인터넷 기술 블로그"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://zuminternet.github.io/"/>
    <meta property="og:image" content="ttp://lego.zumst.com/resources/current/images/thumb_zum.jpg"/>
    <meta property="og:description" content="생각을 읽다, ZUM, 고객의 생각을 읽고 담는 줌 인터넷 개발자들의 '좀 다른 개발 이야기'를 소개 합니다."/>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/OAuth2-Social/">
    <link rel="alternate" type="application/rss+xml" title="ZUM 기술 블로그" href="http://localhost:4000/feed.xml" />
</head>

    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-google-plus" viewBox="0 0 951 1024"><path class="path1" d="M420 454.857q0 20.571 18.286 40.286t44.286 38.857 51.714 42 44 59.429 18.286 81.143q0 51.429-27.429 98.857-41.143 69.714-120.571 102.571t-170.286 32.857q-75.429 0-140.857-23.714t-98-78.571q-21.143-34.286-21.143-74.857 0-46.286 25.429-85.714t67.714-65.714q74.857-46.857 230.857-57.143-18.286-24-27.143-42.286t-8.857-41.714q0-20.571 12-48.571-26.286 2.286-38.857 2.286-84.571 0-142.571-55.143t-58-139.714q0-46.857 20.571-90.857t56.571-74.857q44-37.714 104.286-56t124.286-18.286h238.857l-78.857 50.286h-74.857q42.286 36 64 76t21.714 91.429q0 41.143-14 74t-33.714 53.143-39.714 37.143-34 35.143-14 37.714zM336.571 400q21.714 0 44.571-9.429t37.714-24.857q30.286-32.571 30.286-90.857 0-33.143-9.714-71.429t-27.714-74-48.286-59.143-66.857-23.429q-24 0-47.143 11.143t-37.429 30q-26.857 33.714-26.857 91.429 0 26.286 5.714 55.714t18 58.857 29.714 52.857 42.857 38.286 55.143 14.857zM337.714 898.857q33.143 0 63.714-7.429t56.571-22.286 41.714-41.714 15.714-62.286q0-14.286-4-28t-8.286-24-15.429-23.714-16.857-20-22-19.714-20.857-16.571-23.714-17.143-20.857-14.857q-9.143-1.143-27.429-1.143-30.286 0-60 4t-61.429 14.286-55.429 26.286-39.143 42.571-15.429 60.286q0 40 20 70.571t52.286 47.429 68 25.143 72.857 8.286zM800.571 398.286h121.714v61.714h-121.714v125.143h-60v-125.143h-121.143v-61.714h121.143v-124h60v124z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol></defs></svg>

        <header class="bar-header">
    <a id="menu">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a>
    <a id="search" class="dosearch">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    <h1 class="logo">
        <img src="/images/portal/post/logo_zum_2x-78df1cde157641c8f4178f86826539e8.png"">
        <a href="/">
            
        </a>
    </h1>
</header>

<div id="mask" class="overlay"></div>

<aside id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
          <li><a href="http://localhost:4000">Home</a></li>
          <li><a href="http://zuminternet.com" target="_blank">Contact</a></li>
        <li><a class="feed" href="http://localhost:4000/feed.xml" title="Atom/RSS feed">Feed</a></li>
      </ul>
    </nav>
</aside>
<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>


        <section class="post">

            <article role="article" id="post" class="post-content" itemprop="articleBody">
                <p itemprop="post-info" class="post-info">
                    
                        <svg id="date" class="icon-calendar"><use xlink:href="#icon-calendar"></use></svg>
                        <time itemprop="datePublished" datetime="2017-07-04T00:00:00+09:00" class="date">
                            


July 4, 2017

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>4 min to read</span>
                </p>
                <h1 class="post-title" itemprop="name">Spring Boot & OAuth2 기반 소셜 댓글 시스템 개발하기</h1>
            <p/>
                <p>회사에서의 잉여력 + 개인의 잉여력을 가지고 회사에도 도움 + 개인적인 공부에도 도움이 되는 프로젝트를 진행해 보고 싶었습니다.<br />
제가 맡고 있는 서비스에 아쉬운점이 소셜 댓글이 없다는 것인데(ㅠ.ㅠ) 아쉬움도 달래고 공부도 하고 제 서비스에 댓글기능도 붙일겸 직접 소셜 인증(페이스북, 구글, 트위터, 카카오) &amp; 간단한 댓글 Getting Started를 
개발하기로 야심찬 계획(?)을 세웠습니다.<br /> 
<strong>모든 소스는 <a href="https://github.com/young891221/spring-boot-social-comment">github</a>에 있습니다.</strong></p>

<h2 id="개요">개요</h2>
<p><strong><em>목표는 페이스북, 구글, 트위터, 카카오 등 국내에서 많이 쓰이는 서비스들의 OAuth인증을 통한 댓글 시스템 구현하기!</em></strong>
<br />
여기서 트위터를 제외한 다른 인증은 모두 OAuth2를 사용합니다. Spring에는 이를 구현한 고마운 라이브러리인 Spring Social과 <strong>Spring Security OAuth2</strong>가 있습니다. 전자의 경우 마지막 업데이트가 2년전이고 정해진 디비 스키마에 데이터가 저장되는 방식이라 
커스터마이징한 개발이 가능한 후자를 선택하였습니다. Spring Security OAuth2는 인증과 개인정보 API가 내부로직을 몰라도 될 만큼 편리하게 구현되어 있어 그냥 갔다 쓰시면 됩니다. 그래도 개발자라면 어떻게 동작하는지 정도는 알아야 겠다는 마음가짐(?) 
때문에 동작 프로세스 정도는 소스를 까보면서 분석해 보았습니다.(추후 세션에서…)<br /></p>
<blockquote>
  <p>cf.트위터 developer 사이트를 들어가 보시면 <a href="https://dev.twitter.com/oauth/application-only">Application-only authentication</a>으로 OAuth2를 제공해 준다고 설명되어 있습니다. 
하지만 이는 Client Credentials Grant로 Application 본인에 대한 인증만 사용할 수 있고 유저에 대한 정보를 가져올 수 없어서 제가 만드는 프로젝트에서는 부합하지 못하였습니다. 다음 세션에서 더 자세히 설명하겠습니다.</p>
</blockquote>

<h2 id="필요한-정보-모으기oauth2란">필요한 정보 모으기(OAuth2란?)</h2>
<p>OAuth는 임시 인증을 위한 방식으로 Token을 사용하는데 이를 표준적인 방법으로 통일한 것입니다. OAuth2는 OAuth protocol의 2버전입니다. 이 프로토콜은 3rd party를 위한 범용적인 인증 표준이 됩니다.
OAuth2에서 제공하는 인증 타입 방식은 현재 4가지가 있습니다.(Authorization grant types, Implicit Grant, Resource Owner Password Credentials Grant, Client Credentials Grant 등) 
그중 저에게 필요한 방식은 <strong>Authorization grant types</strong>입니다. Authorization grant types는 웹 서버에서 long-lived access token을 사용하여 사용자 인증을 처리하는 방식으로 제가 선택한 
페이스북, 구글, 카카오가 사용하는 방식입니다. 아래 그림의 Flow를 보시면 더 이해하기 쉽습니다.</p>

<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/auth_code_flow.png" />
</p>

<ul>
  <li>Resource Owner: 인증이 필요한 유저</li>
  <li>Client: 웹 사이트</li>
  <li>Authorization Server: 페이스북/구글/카카오 서버</li>
  <li>Resource Server: 페이스북/구글/카카오 서버</li>
</ul>

<p>반면에 개요에서 말한 트위터가 제공하는 <strong>Client Credentials Grant</strong> 방식은 client 자신이 resource owner가 되는 방식입니다. 이 방식은 client 이외의 다른 resource owner로부터 정보를 얻을 수 있는 권한이 없습니다. 
<strong>애초에 resource owner가 없으므로 사용자의 개인정보를 얻을 수 없는 방식입니다.</strong> 따라서 제가 만드려는 소셜 댓글 플랫폼에는 사용할 수 없었습니다.(그래서 트위터는 OAuth1방식으로…ㅠㅠ)</p>

<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/client_credentials_flow.png" />
</p>

<blockquote>
  <p>번외로 Implicit Grant 방식은 Authorization grant types처럼 서버와 서버에서 인증을 수행하는 방식으로 클라이언트가 token이나 secret이 노출되지 않는 것과는 다르게 javascript처럼 resource owner쪽에서 전적으로 인증을 수행하는 방식입니다.</p>
</blockquote>

<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/directory2.png" width="50%" />
</p>
<p align="center">
<code>Spring Security OAuth2에는 인증타입이 모두 구현되어 있습니다</code>
</p>

<h2 id="프로젝트-환경">프로젝트 환경</h2>
<p>다음은 프로젝트 개발 환경과 사용한 라이브러리입니다.</p>
<ul>
  <li>Java8</li>
  <li>Spring Boot 1.5.2</li>
  <li>Spring Security Oauth2</li>
  <li>Spring Social Twitter</li>
  <li>JPA</li>
  <li>lombok</li>
  <li>logback</li>
  <li>Gradle 3.5</li>
  <li>h2</li>
  <li>embedded redis(for session)</li>
  <li>Freemarker</li>
  <li>handlebars.js</li>
</ul>

<h2 id="설계">설계</h2>
<p>인증요청시 Spring Security에 설정된 필터를 통해 인증이 수행되고 인증이 완료되면 redis를 사용해 세션정보를 담습니다. 회원에 대한 정보는 h2 db에 심플한 정보로 저장하여 사용합니다.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/architecture.png" />
</p>

<h2 id="기본-구현-프로세스">기본 구현 프로세스</h2>
<h3 id="소셜정보-설정">소셜정보 설정</h3>
<p>소셜관련 clientId, clientSecret의 정보를 application.yml에 넣어줍니다. 
페이스북의 경우는 userInfo정보를 가져오기 위한 API 규격이 다름니다. 다른 소셜인증의 경우 필요한 디폴트 정보가 왠만큼 다 있고 scope에 요청정보를 명시해 주는 형식이지만 
 페이스북은 <code class="highlighter-rouge">fields</code>파라미터를 사용하여 <code class="highlighter-rouge">fields=id,name,email</code> 형식으로 요청해야 정상적으로 동작합니다.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/social_config.png" width="35%" />
</p>

<h3 id="clientauthenticationscheme">clientAuthenticationScheme?</h3>
<p><code class="highlighter-rouge">clientAuthenticationScheme</code>의 경우 디폴트는 <code class="highlighter-rouge">header</code>로 지정되며 <code class="highlighter-rouge">form</code>과 <code class="highlighter-rouge">query</code>는 같은 방식으로 동작합니다. 이 로직 처리는 <code class="highlighter-rouge">DefaultClientAuthenticationHandler</code> 클래스에서 진행되며 
<code class="highlighter-rouge">header</code>의 경우 아래와 같이 clientId와 clientSecret을 Base64로 인코등히여 헤더에 포함되는 형식으로 request를 요청합니다.
 이에 관한 자세한 사항은 <a href="http://www.rfc-editor.org/rfc/rfc7617.txt">OAuth2 Spec 문서</a>를 참고하시기 바랍니다.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/scheme.png" width="80%" />
</p>
<p align="center">
<code>clientAuthenticationScheme Class</code>
</p>

<h3 id="인증처리용-filter-설정">인증처리용 Filter 설정</h3>
<p>Security설정에서 <code class="highlighter-rouge">OAuth2ClientAuthenticationProcessingFilter</code>라는 인증처리용 필터를 가져와서 소셜별로 필요한 설정들을 해줍니다. 그리고 마지막에 <code class="highlighter-rouge">FilterRegistrationBean</code>에게 소셜 필터리스트를 set해주고 빈으로 등록해 줍니다. 
<code class="highlighter-rouge">FilterRegistrationBean</code>는 SecurityConfig 이외에 다른 곳에 빈으로 등록하여 사용하셔도 무방합니다.(Filter들의 결집을 위해?) 
SecurityConfig는 <a href="https://github.com/young891221/spring-boot-social-comment/blob/master/social-comment/src/main/java/com/social/config/SecurityConfig.java">여기</a>를 참조하세요.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/source1.png" />
</p>

<p><code class="highlighter-rouge">OAuth2ClientAuthenticationProcessingFilter</code>의 내부를 까보면 <code class="highlighter-rouge">attemptAuthentication</code>이라는 오버라이드된 메소드가 있는데 추후 내부로직 진행이 어떻게 흘러가는지 궁금하시다면 
이 부분을 기준으로 주요로직들의 흐름을 읽으실 수 있습니다.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/source3.png" width="95%" />
</p>

<h3 id="인증-후-세션처리">인증 후 세션처리</h3>
<p>인증이 완료되면 위의 필터의 <code class="highlighter-rouge">setAuthenticationSuccessHandler</code>에서 설정한 경로로 리다이렉트됩니다. 저는 AOP를 사용하여 <code class="highlighter-rouge">@SocialUser</code>라는 파라미터를 가진 놈들에게 세션에 있는 user 데이터를 바로 반환하거나 인증이 완료된 후 
userDetails에 관한 정보를 User 객체에 맵핑하여 db에 저장해 주고 애노테이션에 선언된 user 객체에 바인딩시켜주는 방식을 사용하였습니다. 즉, <code class="highlighter-rouge">@SocialUser</code>를 선언한 파라미터는 user에 대한 정보를 가져올 수 있습니다. 
 이 부분에 대한 자세한 소스는 <a href="https://github.com/young891221/spring-boot-social-comment/blob/master/social-comment/src/main/java/com/social/aop/UserAspect.java">이곳</a>을 참조하세요.</p>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/source2.png" width="80%" />
</p>

<blockquote>
  <p>여기서 포인트컷을 <code class="highlighter-rouge">execution(* *(.., @com.social.annotation.SocialUser (*), ..))</code>와 같이 선언하는 것은 모든 반환타입, 모든 메소드에 @SocialUser 애노테이션이 달려 있는 파라미터를 
찾는 다는 의미입니다.(자세한 내용은 <a href="http://haviyj.tistory.com/36">이곳</a>을 참조해 주세요) 하지만, 이와 같은 방식은 부트구동시 모든 빈을 탐색하기에 runtime이 굉장히 오래 걸립니다.<br />
따라서 위와 같은 방식의 파라미터 애노테이션을 사용한 방식을 구현하고 싶으시다면 <code class="highlighter-rouge">HandlerMethodArgumentResolver</code>와 같은 인터페이스를 구현하여 사용하시는게 바람직합니다.</p>
</blockquote>

<h3 id="트위터-인증은">트위터 인증은?</h3>
<p>트위터는 어쩔 수 없이 <code class="highlighter-rouge">Spring-social-twitter</code>를 사용하여 OAuth1 Spec으로 구현하였습니다. 
이 부분은 <a href="https://github.com/young891221/spring-boot-social-comment/blob/master/social-comment/src/main/java/com/social/controller/TwitterController.java">소스</a>를 직접 참고하세요~</p>

<h3 id="인증-이외에">인증 이외에..</h3>
<p>redis는 일부러 embbeded redis를 썼습니다. 추후 실서비스에 적용한다면 바꿔야 겠지만..Getting Started 느낌으로 어디서나 구동하기 좋고 따로 설치와 관리가 필요없기에 사용하기 편리하였습니다.<br />
댓글은 1댑스의 대댓글 기능을 만들고자 하였으나 귀차니즘이 발동하여…대댓글 없이 댓글 하나씩만 달수 있도록 하였습니다.</p>

<h2 id="결과">결과</h2>
<p>로그인 인증만 테스트해 볼 수 있는 페이지와 댓글기능 사용시 인증할 수 있는 페이지 2개로 구성되어 있습니다. 댓글 제공 방식은 view나 Json으로 데이터를 전송하는 방식을 생각해 보았습니다.</p>
<ul>
  <li>http://localhost:8080/comment/{service}/{id}</li>
  <li>http://localhost:8080/json/comment/{service}/{id}</li>
</ul>
<p align="center">
<img src="/images/portal/post/2017-07-04-OAuth2-Social/view_json.png" />
</p>
<p align="center">
<code>css는 넘나 어렵네요..</code>
</p>

<h2 id="참고사이트">참고사이트</h2>
<ul>
  <li><a href="https://spring.io/guides/tutorials/spring-boot-oauth2/">spring boot oauth2</a></li>
  <li><a href="http://www.bubblecode.net/en/2016/01/22/understanding-oauth2/">oauth2 spec</a></li>
  <li><a href="https://brunch.co.kr/@sbcoba/8">이수홍님의 oauth2</a></li>
  <li><a href="https://github.com/kstyrc/embedded-redis">embbeded redis</a></li>
</ul>

            </article>

            <div class="progress-bar" data-minutes="4">
                <span class="time-completed"></span>
                <span class="time-remaining"></span>
                <div class="bar">
                    <span class="completed" style="width:0%;"></span>
                    <span class="remaining" style="width:100%;"></span>
                </div>
            </div>

            <!--<section class="share">-->
    <!--<h3>Share</h3>-->
    <!--<a aria-label="Compartilhar no Twitter" href="https://twitter.com/intent/tweet?text=&quot;&quot;%20http://localhost:4000/OAuth2-Social/%20via%20&#64;@zum_com&hashtags=Spring Boot,OAuth2,Social,Comment,"-->
    <!--onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">-->
        <!--<svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>-->
    <!--</a>-->
    <!--<a aria-label="Compartilhar no Facebook"href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/OAuth2-Social/"-->
    <!--onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">-->
        <!--<svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>-->
    <!--</a>-->
    <!--<a aria-label="Share on Google Plus" href="https://plus.google.com/share?url=http://localhost:4000/OAuth2-Social/"-->
    <!--onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title="Share on Google+">-->
        <!--<svg class="icon icon-google-plus"><use xlink:href="#icon-google-plus"></use></svg>-->
    <!--</a>-->
<!--</section>-->

            <section class="author" itemprop="author">
  <div class="details" itemscope itemtype="http://schema.org/Person">
    <img itemprop="image" class="img-rounded" src="/images/portal/author/yjinzum.png" alt="">
    <p class="def">포털개발팀 김영재 담당</p>
    <h3 class="name">
      <a itemprop="name" href="https://github.com/zuminternet"></a>
    </h3>
    <p class="desc">zum.com service <br/> Front-End & Back-End Developer.</p>
    <p>
      
      <a itemprop="github" href="https://github.com/zuminternet" title="Github">
        <svg><use xlink:href="#icon-github"></use></svg>
      </a>
      
      
      <a itemprop="facebook" href="https://www.facebook.com/zumcom" title="Facebook">
        <svg><use xlink:href="#icon-facebook"></use></svg>
      </a>
      
      
      <a itemprop="twitter" href="https://twitter.com/@zum_com" title="Twitter">
        <svg><use xlink:href="#icon-twitter"></use></svg>
      </a>
      
      
      
      
    </p>
  </div>
</section>

            <!--<section class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
</section>
<script type="text/javascript">
    var disqus_loaded = false;

    function load_disqus()
    {
        disqus_loaded = true;
        var disqus_shortname = 'disqus_username';
        var disqus_title = '';
        var disqus_url = '/OAuth2-Social/';
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        var ldr = document.getElementById('disqus_loader');
    };
    window.onscroll = function(e) {
        if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 800)) {
            //hit bottom of page
            if (disqus_loaded==false)
                load_disqus()
        }
    };
</script>
-->
            <footer>
    <p>
      
      <a itemprop="github" href="https://github.com/zuminternet" title="Github">
        <svg><use xlink:href="#icon-github"></use></svg>
      </a>
      
      
      <a itemprop="facebook" href="https://www.facebook.com/zumcom" title="Facebook">
        <svg><use xlink:href="#icon-facebook"></use></svg>
      </a>
      
      
      <a itemprop="twitter" href="https://twitter.com/@zum_com" title="Twitter">
        <svg><use xlink:href="#icon-twitter"></use></svg>
      </a>
      
      
      
      
    </p>
    <ul>

        <!---->
          <!--<li><a href="http://localhost:4000">Home</a></li>-->
        <!---->
          <!--<li><a href="http://localhost:4000">Contact</a></li>-->
        <!---->

        <li><a href="http://localhost:4000">Home</a></li>
        <li><a href="http://zuminternet.com" target="_blank">Contact</a></li>
        <li><a class="feed" href="http://localhost:4000/feed.xml" title="Atom/RSS feed">Feed</a></li>
    </ul>
</footer>
<script src="/assets/js/main.js"></script>
// <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-XXXXXXXX-X', 'auto');
  ga('send', 'pageview');

</script>
  


        </section>
    </body>
</html>
